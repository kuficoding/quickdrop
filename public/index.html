<html>
<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="./css/strap.css" rel="stylesheet">

	<title>quickDrop - Easy file transfer</title>
	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
	<script type="text/javascript">
		
		$(function (){
			var file, blob;

			document.getElementById('files').addEventListener('change', function (evt){
				var files = document.getElementById('files').files;
				if (!files.length) {
					alert('Please select a file!');
					return;
				}

				file = files[0];
  				blob = file.slice(0, file.size);
    		}, false);
			
			function addAlert (strong, message){
				var alert = $('<div class="alert alert-success alert-dismissable display:none"><span class="glyphicon glyphicon-export" /><strong> ' 
						+ strong 
						+ '</strong> ' 
						+ message
						+ '</div>');
				$(".alerts").append(alert)
				alert.fadeIn();
			}

			$(".menu-send").hide();
			$(".menu-receive").hide();

			$("#menu-sr-send").click(function (){
				$(".menu-sr").hide();
				$(".menu-send").fadeIn();
				$("#send-file").click(function (){
					var peer = new Peer({key:'yqzjutu8hfv9rudi'});
					console.log($("#id-sender").val());
					var conn = peer.connect($("#id-sender").val());
					conn.on('open', function() {
  						// Receive messages
  						console.log('connected to recipient');
  						conn.on('data', function(data) {
  							console.log('Received', data);
  						});

					  	if (blob){
					  		var _filename = $('input[type=file]').val().replace(/C:\\fakepath\\/i, '');
					  		var data = {
					  			id:'file',
					  			filename: _filename,
					  			blob: blob, 
					  			size: file.size
					  		}
					  		conn.send(data);	
					  		addAlert('File sent!', 'Your file ' + data.filename + ' has transformed and rolled out...');
					  	}
 					 	
					});
				});
			});
			$("#menu-sr-receive").click(function (){
				$(".menu-sr").hide();
				$(".menu-receive").fadeIn();
				var num = Math.floor(Math.random() * 90000) + 10000;
				var peer = new Peer(num.toString(), {key:'yqzjutu8hfv9rudi'});
				$("#pin").text(' Your PIN: ' + num)
				peer.on('connection', function(conn){
					conn.on('open', function() {
  						console.log('connected to sender');
  						conn.on('data', function(data) {
  							if (data.id == 'file'){
  								if (data.blob.constructor === ArrayBuffer) {
  									var saveData = (function () {
  										var a = document.createElement("a");
  										document.body.appendChild(a);
  										a.style = "display: none";
  										return function (data, fileName) {
  											var dataView = new Uint8Array(data);
  											var dataBlob = new Blob([dataView]);
  											var url = window.URL.createObjectURL(dataBlob);
  											a.href = url;
  											a.download = fileName;
  											a.click();
  											window.URL.revokeObjectURL(url);
  										};
  									}());
  									var r=confirm("Someone is trying to send a file... \n " + data.filename + " (" + data.size/1000 + " K)");
  									if (r)saveData(data.blob, data.filename);
  									
        						}
  							}
  						});
 					});
				})
			});
		});
	</script>

</head>


<body>
	<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					
				</button>
				<a class="navbar-brand" href="#">quickdrop</a>
			</div>
			<div class="collapse navbar-collapse">
				<ul class="nav navbar-nav">
					<li><a href="https://github.com/sameid">github</a></li>
				</ul>
			</div><!--/.nav-collapse -->
		</div>
	</div>

	<div class="container">

		<div class="strap menu-sr">
			<button class="btn btn-primary btn-lg" id="menu-sr-send">
				<span class="glyphicon glyphicon-send"></span> Send a file
			</button> 
			<p></p>
			<button class="btn btn-success btn-lg" id="menu-sr-receive">
				<span class="glyphicon glyphicon-import"></span> Receive a file
			</button>
		</div>

		<div class="strap menu-send">
			<input type="file" id="files" name="file" data-classInput="input-small" data-classButton="btn btn-info"/> 
			<p></p>
			<div class="input-group input-group-lg">
				<input type="tel" class="form-control" placeholder="Enter Reciepient PIN" id="id-sender">
				<span class="input-group-btn">
					<button class="btn btn-primary btn-lg" id="send-file">
						<span class="glyphicon glyphicon-send"></span> Send
					</button>
				</span>
			</div>
			<p></p>
			<div class="alerts"></div>
			
		</div>

		<div class="strap menu-receive">
			<div class="alerts">
				<div class="alert alert-info alert-dismissable">
					<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					<span class="glyphicon glyphicon-th"></span><strong id="pin"> Your pin:</strong> Waiting on sender...
				</div>
			</div>
		</div>

	</div><!-- /.container -->
</body>
</html>